# 5ch風匿名掲示板 - 実装仕様書

## プロジェクト概要

### 技術スタック
- **フロントエンド**: Next.js 14 (Pages Router) + TypeScript
- **バックエンド**: Next.js API Routes (ローカル実行)
- **データベース**: SQLite (better-sqlite3)
- **スタイリング**: Tailwind CSS + shadcn/ui + Radix UI
- **アイコン**: Lucide Icons
- **アニメーション**: Framer Motion

### プロジェクト目的
完全匿名で利用できる5ch風の掲示板をローカル環境で動作させる。会員登録不要で誰でも投稿できるシンプルな実装。

---

## 1. セットアップ手順

### 1.1 必要な環境
- Node.js 18.x 以上
- npm または yarn

### 1.2 インストール手順

```bash
# 依存関係のインストール
npm install

# データベースのセットアップ
npm run db:setup

# 開発サーバーの起動
npm run dev
```

### 1.3 アクセス方法
ブラウザで `http://localhost:3000` にアクセス

---

## 2. データベース設計

### 2.1 テーブル構造

#### boards（板）テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INTEGER | PRIMARY KEY | 板ID（自動採番） |
| name | TEXT | NOT NULL, UNIQUE | 板名 |
| description | TEXT | NOT NULL | 板の説明 |
| category | TEXT | NOT NULL | カテゴリ |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

#### threads（スレッド）テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INTEGER | PRIMARY KEY | スレッドID |
| board_id | INTEGER | NOT NULL, FOREIGN KEY | 所属する板ID |
| title | TEXT | NOT NULL | スレッドタイトル |
| post_count | INTEGER | DEFAULT 1 | レス数 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| last_posted_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 最終投稿日時 |
| status | TEXT | DEFAULT 'active' | ステータス（active/archived） |

#### posts（レス）テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | INTEGER | PRIMARY KEY | レスID |
| thread_id | INTEGER | NOT NULL, FOREIGN KEY | 所属するスレッドID |
| post_number | INTEGER | NOT NULL | レス番号（1から開始） |
| name | TEXT | DEFAULT '名無しさん' | 投稿者名 |
| email | TEXT | - | メール欄（sage等） |
| posted_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 投稿日時 |
| poster_id | TEXT | NOT NULL | 投稿者ID（日替わりハッシュ） |
| content | TEXT | NOT NULL | 本文 |
| is_deleted | INTEGER | DEFAULT 0 | 削除フラグ |

### 2.2 インデックス
- `idx_threads_board_id`: threads(board_id)
- `idx_threads_last_posted`: threads(last_posted_at DESC)
- `idx_posts_thread_id`: posts(thread_id)
- `idx_posts_post_number`: posts(thread_id, post_number)

### 2.3 初期データ
セットアップ時に以下の板を自動作成：
- ニュース速報（ニュースカテゴリ）
- 技術（技術カテゴリ）
- アニメ（趣味カテゴリ）
- ゲーム（趣味カテゴリ）
- 料理（生活カテゴリ）
- 雑談（その他カテゴリ）

---

## 3. API設計

### 3.1 板関連API

#### GET `/api/boards`
全ての板を取得

**レスポンス例:**
```json
[
  {
    "id": 1,
    "name": "ニュース速報",
    "description": "最新ニュースについて語りましょう",
    "category": "ニュース",
    "thread_count": 5,
    "last_updated": "2026-01-08T12:00:00.000Z"
  }
]
```

#### GET `/api/boards/[boardId]`
特定の板の詳細を取得

**レスポンス例:**
```json
{
  "id": 1,
  "name": "ニュース速報",
  "description": "最新ニュースについて語りましょう",
  "category": "ニュース",
  "created_at": "2026-01-08T10:00:00.000Z"
}
```

### 3.2 スレッド関連API

#### GET `/api/boards/[boardId]/threads`
板内のスレッド一覧を取得

**クエリパラメータ:**
- `page`: ページ番号（デフォルト: 1）
- `sort`: ソート順（last_posted/created/post_count、デフォルト: last_posted）

**レスポンス例:**
```json
{
  "threads": [
    {
      "id": 1,
      "board_id": 1,
      "title": "今日のニュース",
      "post_count": 42,
      "created_at": "2026-01-08T10:00:00.000Z",
      "last_posted_at": "2026-01-08T12:30:00.000Z",
      "status": "active"
    }
  ],
  "total": 10,
  "page": 1,
  "totalPages": 1
}
```

#### POST `/api/boards/[boardId]/threads`
新規スレッドを作成

**リクエストボディ:**
```json
{
  "title": "スレッドタイトル",
  "name": "名無しさん",
  "content": "本文"
}
```

**バリデーション:**
- title: 必須、1〜100文字
- content: 必須、1〜1000文字
- name: 任意、50文字以内
- 同一タイトルの重複チェック

**レスポンス例:**
```json
{
  "threadId": 123,
  "message": "スレッドを作成しました"
}
```

#### GET `/api/threads/[threadId]`
スレッドの詳細を取得

**レスポンス例:**
```json
{
  "id": 1,
  "board_id": 1,
  "title": "今日のニュース",
  "post_count": 42,
  "created_at": "2026-01-08T10:00:00.000Z",
  "last_posted_at": "2026-01-08T12:30:00.000Z",
  "status": "active"
}
```

### 3.3 レス関連API

#### GET `/api/threads/[threadId]/posts`
スレッド内のレス一覧を取得

**クエリパラメータ:**
- `page`: ページ番号（デフォルト: 1）

**レスポンス例:**
```json
{
  "posts": [
    {
      "id": 1,
      "thread_id": 1,
      "post_number": 1,
      "name": "名無しさん",
      "email": "",
      "posted_at": "2026-01-08T10:00:00.000Z",
      "poster_id": "ABC12345",
      "content": "本文です",
      "is_deleted": 0
    }
  ],
  "total": 42,
  "page": 1,
  "totalPages": 1
}
```

#### POST `/api/threads/[threadId]/posts`
レスを投稿

**リクエストボディ:**
```json
{
  "name": "名無しさん",
  "email": "",
  "content": "本文"
}
```

**バリデーション:**
- content: 必須、1〜1000文字
- name: 任意、50文字以内
- email: 任意、50文字以内（"sage"でスレッドが上がらない）
- スレッドが1000レス以上でないこと
- スレッドステータスがactiveであること

**レスポンス例:**
```json
{
  "postNumber": 43,
  "message": "レスを投稿しました"
}
```

---

## 4. ページ構成

### 4.1 トップページ (`/`)

#### 機能
- 全ての板をカテゴリ別にグループ化して表示
- 各板のスレッド数を表示
- 板をクリックでスレッド一覧へ遷移

#### UI要素
- ヘッダー: サイトロゴとタイトル
- メインコンテンツ: 板のカード一覧（カテゴリごと）
- フッター: コピーライト

#### アニメーション
- ページ読み込み時にカードがフェードイン
- カテゴリごとに時間差でアニメーション
- ホバー時にカードが少し拡大

### 4.2 板ページ (`/board/[boardId]`)

#### 機能
- 板内のスレッド一覧を表示
- 最終投稿日時順にソート（デフォルト）
- ページネーション（50件/ページ）
- 新規スレッド作成ボタン

#### UI要素
- ヘッダー: 戻るボタン、板名、説明、新規スレッド作成ボタン
- スレッド一覧: タイトル、レス数、最終投稿日時
- ページネーション: 前へ/次へボタン

#### アニメーション
- スレッド項目が順番にフェードイン
- ホバー時に背景色変更

### 4.3 スレッド作成ページ (`/board/[boardId]/new`)

#### 機能
- スレッドタイトル入力
- 名前入力（任意、デフォルト「名無しさん」）
- 本文入力
- 文字数カウント表示
- バリデーション

#### UI要素
- フォーム: タイトル、名前、本文
- 送信ボタン
- キャンセルボタン
- 注意事項の表示

#### バリデーション
- タイトル: 必須、100文字以内
- 本文: 必須、1000文字以内
- 名前: 任意、50文字以内

### 4.4 スレッド詳細ページ (`/board/[boardId]/thread/[threadId]`)

#### 機能
- スレッド内の全レスを時系列表示
- レス投稿フォーム
- ページネーション（100件/ページ）
- レスアンカー機能（>>123形式）
- URLの自動リンク化

#### UI要素
- ヘッダー: 戻るボタン、スレッドタイトル
- レス一覧: レス番号、名前、投稿日時、ID、本文
- 投稿フォーム: 名前、メール、本文
- ページネーション

#### 特殊機能
- sage機能: メール欄に「sage」入力でスレッドが上がらない
- レスアンカー: >>123で該当レスへジャンプ
- 1000レス達成でdat落ち（書き込み不可）

#### アニメーション
- レスが順番にフェードイン
- 投稿後に新しいレスがアニメーション付きで表示

---

## 5. コンポーネント設計

### 5.1 shadcn/ui コンポーネント

#### 使用コンポーネント
- **Button**: アクション実行用ボタン
- **Card**: 板やスレッドの情報表示
- **Input**: テキスト入力フィールド
- **Textarea**: 長文入力フィールド
- **Label**: フォームラベル
- **Separator**: 区切り線

#### スタイルカスタマイズ
- Tailwind CSSのユーティリティクラスで調整
- cn()関数でクラス名を動的に結合

### 5.2 カスタムコンポーネント

#### BoardCard
板の情報を表示するカードコンポーネント
- props: board（板データ）
- Framer Motionでホバーエフェクト

#### ThreadItem
スレッド一覧の各項目コンポーネント
- props: thread（スレッドデータ）
- クリックでスレッド詳細へ遷移

#### PostItem
レス表示用コンポーネント
- props: post（レスデータ）
- HTMLエスケープ済みの本文を表示
- レスアンカーとURLをリンク化

#### PostForm
レス投稿フォームコンポーネント
- props: threadId, onSubmit
- バリデーション機能付き

---

## 6. ユーティリティ関数

### 6.1 `generatePosterId(ip: string): string`
IPアドレスから日替わりIDを生成

**ロジック:**
```
SHA256(IPアドレス + 日付 + ソルト) → 先頭8文字を大文字で返す
```

**例:**
```typescript
generatePosterId('192.168.1.1') // => 'ABC12345'
```

### 6.2 `escapeHtml(text: string): string`
HTMLの特殊文字をエスケープ

**変換:**
- `&` → `&amp;`
- `<` → `&lt;`
- `>` → `&gt;`
- `"` → `&quot;`
- `'` → `&#039;`

### 6.3 `linkifyUrls(text: string): string`
URLを自動的にリンク化

**正規表現:**
```
/(https?:\/\/[^\s]+)/g
```

### 6.4 `linkifyAnchors(text: string): string`
レスアンカーをリンク化

**正規表現:**
```
/&gt;&gt;(\d+)/g
```

**変換例:**
```
&gt;&gt;123 → <a href="#post-123">&gt;&gt;123</a>
```

### 6.5 `processPostContent(text: string): string`
投稿内容を処理（エスケープ → URL化 → アンカー化）

### 6.6 `formatDate(dateString: string): string`
日時を5ch風フォーマットで表示

**フォーマット:**
```
2026/01/08(水) 12:34:56
```

---

## 7. セキュリティ対策

### 7.1 XSS対策
- 全てのユーザー入力をHTMLエスケープ
- `escapeHtml()`関数で特殊文字を変換
- dangerouslySetInnerHTMLは使用しない（例外: 処理済みコンテンツのみ）

### 7.2 SQLインジェクション対策
- better-sqlite3のプリペアドステートメントを使用
- 全てのクエリでパラメータバインディング

### 7.3 CSRF対策
- ローカル環境のため最小限の実装
- 本番環境ではCSRFトークンを実装すべき

### 7.4 入力値検証
- 文字数制限の実施
- 必須項目のチェック
- 正規表現によるバリデーション

### 7.5 プライバシー保護
- IPアドレスを直接保存しない
- ハッシュ化したIDのみ保存
- 日替わりでIDが変更される

---

## 8. スタイリング指針

### 8.1 カラーパレット
- Primary: Blue 600 (#2563eb)
- Background: Slate 50-100
- Text: Gray 900
- Muted: Gray 600
- Border: Gray 200-300

### 8.2 レスポンシブデザイン
- モバイル: 1カラムレイアウト
- タブレット: 2カラムレイアウト（板一覧）
- デスクトップ: 3カラムレイアウト（板一覧）

### 8.3 アニメーション
- Framer Motionを使用
- フェードイン: `initial={{ opacity: 0 }}` → `animate={{ opacity: 1 }}`
- スライドイン: `initial={{ y: 20 }}` → `animate={{ y: 0 }}`
- ホバー効果: `whileHover={{ scale: 1.02 }}`
- タップ効果: `whileTap={{ scale: 0.98 }}`

---

## 9. パフォーマンス最適化

### 9.1 データベースクエリ最適化
- インデックスの適切な配置
- 必要なカラムのみを取得
- JOINの最小化

### 9.2 ページネーション
- スレッド一覧: 50件/ページ
- レス一覧: 100件/ページ
- LIMIT/OFFSETで制御

### 9.3 フロントエンド最適化
- 画像の遅延読み込み（将来実装時）
- Reactのメモ化（必要に応じて）
- 不要な再レンダリングの防止

---

## 10. 開発・運用ガイド

### 10.1 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# 本番モード起動
npm start

# データベースセットアップ
npm run db:setup
```

### 10.2 ディレクトリ構造

```
/Users/hm/Desktop/cursor/5chbbs/
├── components/
│   └── ui/              # shadcn/uiコンポーネント
├── lib/
│   ├── db.ts            # データベース接続・初期化
│   └── utils.ts         # ユーティリティ関数
├── pages/
│   ├── api/             # API Routes
│   │   ├── boards/
│   │   └── threads/
│   ├── board/           # 板関連ページ
│   ├── _app.tsx         # アプリケーションルート
│   ├── _document.tsx    # ドキュメント設定
│   └── index.tsx        # トップページ
├── scripts/
│   └── setup-db.js      # DB初期化スクリプト
├── styles/
│   └── globals.css      # グローバルスタイル
├── bbs.db               # SQLiteデータベース（自動生成）
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── next.config.js
```

### 10.3 データベース管理

#### データベースのリセット
```bash
# データベースファイルを削除
rm bbs.db

# 再セットアップ
npm run db:setup
```

#### データベースの確認
```bash
# SQLiteコマンドラインツールで接続
sqlite3 bbs.db

# テーブル一覧
.tables

# データ確認
SELECT * FROM boards;
```

### 10.4 トラブルシューティング

#### ポート3000が既に使用されている
```bash
# プロセスを確認
lsof -i :3000

# プロセスを終了するか、別のポートを指定
PORT=3001 npm run dev
```

#### データベース接続エラー
- `bbs.db`ファイルの存在確認
- `npm run db:setup`で再初期化

#### ビルドエラー
```bash
# node_modulesを削除して再インストール
rm -rf node_modules
npm install
```

---

## 11. 機能制限事項（シンプル実装のため）

### 11.1 実装しない機能
- ユーザー認証・ログイン機能
- 画像アップロード機能
- リアルタイム更新（WebSocket）
- 検索機能（将来実装可能）
- 管理画面（将来実装可能）
- IP制限機能（将来実装可能）
- 禁止ワードフィルター（将来実装可能）

### 11.2 簡略化した実装
- IPアドレス取得: ローカル環境のため簡易版
- 連続投稿制限: 未実装（必要に応じて追加）
- レート制限: 未実装
- バックアップ機能: 手動でbbs.dbをコピー

---

## 12. 今後の拡張案

### 12.1 Phase 2（中期的な追加機能）
- スレッド検索機能
- 板内検索機能
- お気に入りスレッド（LocalStorage）
- レスの引用機能
- 管理画面（スレッド/レス削除）

### 12.2 Phase 3（長期的な追加機能）
- 画像アップロード・表示機能
- リアルタイム更新
- 連続投稿制限
- IP制限機能
- 禁止ワードフィルター
- APIの公開

---

## 13. ライセンスと注意事項

### 13.1 使用上の注意
- このプロジェクトはローカル開発・学習用です
- インターネット公開する場合は追加のセキュリティ対策が必要です
- 違法なコンテンツの投稿は禁止します
- 本番環境で使用する場合は、適切な認証・認可機能を追加してください

### 13.2 依存パッケージのライセンス
各パッケージのライセンスに従ってください：
- Next.js: MIT
- React: MIT
- Tailwind CSS: MIT
- Radix UI: MIT
- better-sqlite3: MIT
- Framer Motion: MIT
- Lucide Icons: ISC

---

**仕様書バージョン**: 1.0  
**作成日**: 2026年1月8日  
**対象環境**: ローカル開発環境  
**想定開発期間**: 1-2週間
